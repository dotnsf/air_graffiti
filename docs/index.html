<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<title>Air Graffiti</title>
<script type="text/javascript" src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
<link href="//maxcdn.bootstrapcdn.com/bootstrap/4.5.1/css/bootstrap.min.css" rel="stylesheet"/>
<script src="//maxcdn.bootstrapcdn.com/bootstrap/4.5.1/js/bootstrap.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js"></script>
<meta name="viewport" content="width=device-width,initial-scale=1"/>

<link rel="shortcut icon" href="./imgs/icon.png" type="image/png"/>
<link rel="icon" href="./imgs/icon.png" type="image/png"/>
<link rel="apple-touch-icon" href="./imgs/icon.png"/>

<meta name="viewport" content="width=device-width,initial-scale=1"/>
<meta name="apple-mobile-web-app-capable" content="yes"/>
<meta name="apple-mobile-web-app-status-bar-style" content="black"/>
<meta name="apple-mobile-web-app-title" content="Air Graffiti"/>

<!-- // OGP tags -->
<meta property="og:title" content="Air Graffiti"/>
<meta property="og:type" content="website"/>
<meta property="og:url" content="//dotnsf.github.io/air_graffiti/"/>
<meta property="og:image" content="//dotnsf.github.io/air_graffiti/imgs/icon.png"/>
<meta property="og:site_name" content="Air Graffiti"/>
<meta property="og:description" content="Air Graffiti"/>
<!-- OGP tags // -->

<!-- // Twitter Card -->
<meta property="twitter:card" content="summary"/>
<meta property="twitter:site" content="@dotnsf"/>
<meta property="twitter:creator" content="@dotnsf"/>
<meta property="twitter:url" content="//dotnsf.github.io/air_graffiti/"/>
<meta property="twitter:image" content="//dotnsf.github.io/air_graffiti/imgs/icon.png"/>
<meta property="twitter:title" content="Air Graffiti"/>
<meta property="twitter:description" content="Air Graffiti"/>
<!-- Twitter Card // -->

<style type="text/css">
html, body{
  text-align: center;
  background-color: #fafafa;
  font-size: 20px;
  color: #333;
}
body{
  background-color: #ffffcc;
}
#mycanvas{
  border: 1px solid #333;
  background-color: #fff;
}
#touchcanvas{
  border: 1px solid #333;
  background-color: #f88;
}
</style>
</head>
<body>

<div class="container">
  <!--
  <canvas id="mychart1" style="position:relative; width:90%; height: 30%;"></canvas>
  <canvas id="mychart2" style="position:relative; width:90%; height: 30%;"></canvas>

  <div id="result"></div>
  -->
  <div id="cdiv">
    <canvas width="80%" height="50%" id="mycanvas"></canvas>
    <canvas id="touchcanvas" style="position:relative; width:80%; height: 20%;"></canvas>
  </div>
</div>

<script>
var isTouch = false;
var motionData = [];
var orientationData = [];

//. iOS 13 対応 : https://bagelee.com/webar-vr/ios13-webar-webvr/
//.             : https://qiita.com/nakakaz11/items/a9be602874bd54819a18
function ClickRequestDeviceSensor(){
  //. ユーザーに「許可」を明示させる必要がある
  DeviceOrientationEvent.requestPermission().then( function( response ){
    if( response === 'granted' ){
      window.addEventListener( "deviceorientation", deviceOrientation );
      $('#sensorrequest').css( 'display', 'none' );
      $('#cdiv').css( 'display', 'block' );
    }
  }).catch( function( e ){
    console.log( e );
  });

  /*
  DeviceMotionEvent.requestPermission().then( function( response ){
    if( response === 'granted' ){
      window.addEventListener( "devicemotion", deviceMotion );
      $('#sensorrequest').css( 'display', 'none' );
      $('#cdiv').css( 'display', 'block' );
    }
  }).catch( function( e ){
    console.log( e );
  });
  */
}

$(function(){
  init();
});

function init(){
  /*
  var canvas = document.getElementById( 'mycanvas' );
  if( !canvas || !canvas.getContext ){
    return false;
  }
  */

  if( window.DeviceOrientationEvent ){
    //. iOS 13 対応 : https://bagelee.com/webar-vr/ios13-webar-webvr/
    //.             : https://qiita.com/nakakaz11/items/a9be602874bd54819a18
    if( DeviceOrientationEvent.requestPermission && typeof DeviceOrientationEvent.requestPermission === 'function' ){
      $('#cdiv').css( 'display', 'none' );
      var banner = '<div id="sensorrequest" onclick="ClickRequestDeviceSensor();" style="z-index:1; position:absolute; width:100%; background-color:#000; color:#fff;><p style="padding:10px;">センサーの有効化</p></div>';
      $('body').prepend( banner );
    }else{
      window.addEventListener( "deviceorientation", deviceOrientation );
    }
  }
  /*
  if( window.DeviceMotionEvent ){
    //. iOS 13 対応 : https://bagelee.com/webar-vr/ios13-webar-webvr/
    //.             : https://qiita.com/nakakaz11/items/a9be602874bd54819a18
    if( DeviceMotionEvent.requestPermission && typeof DeviceMotionEvent.requestPermission === 'function' ){
    }else{
      window.addEventListener( "devicemotion", deviceMotion );
    }
  }
  */

  if( window.TouchEvent ){
    var canvas = document.getElementById( 'touchcanvas' );
    canvas.addEventListener( "touchstart", touchStart );
    canvas.addEventListener( "touchend", touchEnd );
  }

  //. リサイズ時に Canvas サイズを変更する
  $(window).on( 'load resize', function(){
    resized();
  });
  resized();

  //. スクロール禁止
  var movefun = function( event ){
    event.preventDefault();
  }
  window.addEventListener( 'touchmove', movefun, { passive: false } );
}

var canvas_width = 200;
var canvas_height = 200;
function resized(){
  var browserWidth = window.innerWidth;
  var browserHeight = window.innerHeight;
  var canvas = document.getElementById( 'mycanvas' );
  if( canvas && canvas.getContext ){
    canvas.width = canvas_width = browserWidth * 0.8;
    canvas.height = canvas_height = browserHeight * 0.4;

    canvas_width = canvas.width;
    canvas_height = canvas.height;
  }
}

function touchStart( e ){
  e.preventDefault();
  isTouch = true;
  motionData = [];
  orientationData = [];
}

function touchEnd( e ){
  e.preventDefault();
  isTouch = false;

  if( motionData && motionData.length > 0 ){
    //. グラフ描画
    /*
    var labels = [];
    var x_data = [];
    var y_data = [];
    var z_data = [];
    for( var i = 0; i < motionData.length; i ++ ){
      var mot = motionData[i];
      labels.push( '' + i );
      x_data.push( mot['ac'].x );
      y_data.push( mot['ac'].y );
      z_data.push( mot['ac'].z );
    }

    var ctx1 = document.getElementById( 'mychart1' );
    var myChart1 = new Chart( ctx1, {
      type: 'line',
      data: {
        labels: labels,
        datasets: [{
          label: 'x',
          borderWidth: 1,
          backgroundColor: '#ffaaaa',
          borderColor: '#ff5555',
          fill: false,
          data: x_data
        },
        {
          label: 'y',
          borderWidth: 1,
          backgroundColor: '#aaffaa',
          borderColor: '#55ff55',
          fill: false,
          data: y_data
        },
        {
          label: 'z',
          borderWidth: 1,
          backgroundColor: '#aaaaff',
          borderColor: '#5555ff',
          fill: false,
          data: z_data
        }]
      },
      options: {
        title: {
          display: false,
          text: '三軸加速度',
          padding: 3
        },
        legend: {
          labels: {
            boxWidth: 30,
            padding: 20
          },
          display: true
        },
        tooltips: {
          mode: 'label'
        }
      }
    });

    motionData = [];
    */
  }

  if( orientationData && orientationData.length > 0 ){
    //. 描画
    //$('#result').html( '<canvas id="cv" width="' + canvas_width + '" height="' + canvas_height + '" style="display:none;"></canvas><br/><img id="resultimg"/>' );
    var cvs = document.getElementById( "mycanvas" );
    var ctx = cvs.getContext( "2d" );
    ctx.beginPath();

    //. 全体を白でベタ塗り
    ctx.fillStyle = "rgb( 255, 255, 255 )";
    ctx.fillRect( 0, 0, canvas_width, canvas_height );

    var abg = null;
    var x, y;

    //. 最初のデータ
    abg = orientationData[0];
    x = abg['lr'];
    y = abg['fb'];

    //. 始点をマーク（緑）
    ctx.beginPath();
    ctx.fillStyle = "rgb( 0, 255, 0 )";
    ctx.arc( 2 * x + canvas_width / 2, -2 * y + canvas_height / 2, 10, 0, Math.PI * 2, true );
    ctx.fill();

    //. 最後のデータ
    abg = orientationData[orientationData.length-1];
    x = abg['lr'];
    y = abg['fb'];

    //. 終点をマーク（赤）
    ctx.beginPath();
    ctx.fillStyle = "rgb( 255, 0, 0 )";
    ctx.arc( 2 * x + canvas_width / 2, -2 * y + canvas_height / 2, 10, 0, Math.PI * 2, true );
    ctx.fill();

    //. もう一度、最初のデータ
    abg = orientationData[0];
    x = abg['lr'];
    y = abg['fb'];

    //. ペンを始点に移動
    ctx.beginPath();
    ctx.strokeStyle = "rgb( 0, 0, 0 )";
    ctx.lineWidth = 5;
    ctx.moveTo( 2 * x + canvas_width / 2 , -2 * y + canvas_height / 2 );

    //. ２つ目以降のデータ
    for( var i = 1; i < orientationData.length; i ++ ){
      //. ペンの移動を繰り返す
      abg = touchData[i];
      x = abg['lr'];
      y = abg['fb'];
      ctx.lineTo( 2 * x + canvas_width / 2 , -2 * y + canvas_height / 2 );
    }
    ctx.stroke();

    /*
    //. Canvas => Image
    var png = cvs.toDataURL( 'image/png' );
    document.getElementById( "resultimg" ).src = png;

    //. 画像データ取得
    png = png.replace( /^.*,/, '' );

    //. バイナリ変換
    var bin = atob( png );
    var buffer = new Uint8Array( bin.length );
    for( var i = 0; i < bin.length; i ++ ){
      buffer[i] = bin.charCodeAt( i );
    }
    var blob = new Blob( [buffer.buffer], {
      type: 'image/png'
    });

    //. POST
    var formdata = new FormData();
    formdata.append( 'image', blob );

    $.ajax({
      type: "POST",
      url: "./image",
      data: formdata,
      contentType: false,
      processData: false,
      success: function( data, dataType ){
        console.log( data );
      },
      error: function( jqXHR, textStatus, errorThrown ){
        console.log( textStatus + ": " + errorThrown );
      }
    });
    */

    orientationData = [];
  }
}

/*
function deviceMotion( e ){
  e.preventDefault();
  if( isTouch ){
    var ac = e.acceleration;
    var acg = e.accelerationIncludingGravity;
    var rot = e.rotationRate;

    var motion = {};
    motion['ac'] = ac;
    motion['acg'] = acg;
    motion['rot'] = rot;

    motionData.push( motion );
  }
}
*/
function deviceOrientation( e ){
  e.preventDefault();
  if( isTouch ){
    var gamma = e.gamma; //. Left/Right
    var beta = e.beta;   //. Front/Back
    var alpha = e.alpha; //. Direction

    var ori = {};
    ori['dir'] = alpha;
    ori['fb'] = beta;
    ori['lr'] = gamma;

    orientationData.push( ori );
  }
}
</script>
</body>
</html>
